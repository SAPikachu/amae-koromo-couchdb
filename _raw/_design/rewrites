{
  "_id": "_design/rewrites",
  "_rev": "82-2f45d7d572bdeaa69a293d8a70197b71",
  "rewrites": "function(req2) {\n\t\"use strict\";\n\tvar prefix = req2.path[4];\n\tif (prefix !== \"api-test\") {\n\t\treturn {\n\t\t\tcode: 200,\n\t\t\theaders: {\n\t\t\t\t\"Cache-Control\": \"max-age=15\",\n\t\t\t\t\"Content-Type\": \"application/json; charset=utf-8\"\n\t\t\t},\n\t\t\tbody: toJSON({\n\t\t\t\tmaintenance: \"因数据库出现问题，临时维护中，目前预计下周恢复 / ただいまメンテナンス中、来週に復旧できる見込みです。\"\n\t\t\t})\n\t\t};\n\t}\n\tvar basename = req2.path[0];\n\tvar method = req2.path[5];\n\tvar params = req2.path.slice(6);\n\tif (!method) {\n\t\treturn {\n\t\t\tcode: 400,\n\t\t\tbody: toJSON({\n\t\t\t\terror: \"bad_request\"\n\t\t\t})\n\t\t};\n\t}\n\tvar MS_PER_DAY = 1000 * 60 * 60 * 24;\n\tvar parseTs = function(val) {\n\t\t\"use strict\";\n\t\tvar result;\n\t\ttry {\n\t\t\tif (typeof val === \"string\") {\n\t\t\t\tif (val.charAt(0) === \"[\") {\n\t\t\t\t\tval = JSON.parse(val);\n\t\t\t\t} else if (/^\\d+$/.test(val)) {\n\t\t\t\t\tval = parseInt(val);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (typeof val === \"object\" && val.length) {\n\t\t\t\tval[1]--; // Fix month\n\t\t\t\tval = Date.UTC.apply(Date, val);\n\t\t\t}\n\t\t\tif (typeof val === \"number\" && val < (new Date(2000, 0, 1)).getTime()) {\n\t\t\t\tval = val * 1000;\n\t\t\t}\n\t\t\tresult = new Date(val);\n\t\t} catch (e) {\n\t\t\tlog(\"Failed to parse timestamp\");\n\t\t\tlog(e);\n\t\t\treturn null;\n\t\t}\n\t\tif (result.toString().toLowerCase() === \"invalid date\") {\n\t\t\treturn null;\n\t\t}\n\t\treturn result;\n\t};\n\tvar dateToKey = function(date) {\n\t\treturn [date.getUTCFullYear(), date.getUTCMonth() + 1, date.getUTCDate(), date.getUTCHours()];\n\t};\n\tvar dateToSecKey = function(date) {\n\t\treturn date.getTime() / 1000;\n\t};\n\tif (req2.query.limit && parseInt(req2.query.limit) > 500) {\n\t\treq2.query.limit = \"500\";\n\t}\n\tswitch (method) {\n\t\tcase \"recent_highlight_games\":\n\t\t\treturn {\n\t\t\t\tpath: \"/../renderers/_list/highlight_games/highlight_games/highlight_games\",\n\t\t\t\tquery: {\n\t\t\t\t\t\"limit\": req2.query.limit || \"100\",\n\t\t\t\t\t\"skip\": req2.query.skip || \"0\",\n\t\t\t\t\t\"include_docs\": \"true\",\n\t\t\t\t\t\"maxage\": \"300\",\n\t\t\t\t\t\"reduce\": \"false\",\n\t\t\t\t\t\"descending\": \"true\",\n\t\t\t\t\t\"stable\": \"false\",\n\t\t\t\t\t\"update\": \"lazy\"\n\t\t\t\t}\n\t\t\t};\n\t\t\tbreak;\n\t\tcase \"fan_stats\":\n\t\t\treturn {\n\t\t\t\tpath: \"/../renderers/_list/fan_stats/fan_stats/fan_stats\",\n\t\t\t\tquery: ({\n\t\t\t\t\t\"group_level\": \"2\",\n\t\t\t\t\t\"maxage\": \"3600\",\n\t\t\t\t\t\"stable\": \"false\",\n\t\t\t\t\t\"update\": \"lazy\"\n\t\t\t\t})\n\t\t\t};\n\t\t\tbreak;\n\t\tcase \"global_statistics\":\n\t\t\treturn {\n\t\t\t\tquery: {\n\t\t\t\t\tmaxage: \"3600\",\n\t\t\t\t},\n\t\t\t\tpath: \"/../../../\" + basename + \"_aggregates/_design/renderers/_show/global_statistics/global_statistics\",\n\t\t\t};\n\t\t\tbreak;\n\t\tcase \"career_ranking\":\n\t\t\tvar type = params[0];\n\t\t\tif (!type) {\n\t\t\t\treturn {\n\t\t\t\t\tcode: 400,\n\t\t\t\t\tbody: toJSON({\n\t\t\t\t\t\terror: \"no_param\"\n\t\t\t\t\t})\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tpath: \"/../../../\" + basename + \"_aggregates/_design/renderers/_show/career_ranking/career_ranking_\" + type,\n\t\t\t\tquery: {\n\t\t\t\t\tmode: req2.query.mode || \"\"\n\t\t\t\t}\n\t\t\t};\n\t\t\tbreak;\n\t\tcase \"rank_rate_by_seat\":\n\t\t\treturn {\n\t\t\t\tquery: {\n\t\t\t\t\tmaxage: \"3600\",\n\t\t\t\t\tgroup: \"true\",\n\t\t\t\t\t\"stable\": \"false\",\n\t\t\t\t\t\"update\": \"lazy\"\n\t\t\t\t},\n\t\t\t\tpath: \"/../renderers/_list/rank_rate_by_seat/rank_rate_by_seat/rank_rate_by_seat\"\n\t\t\t};\n\t\t\tbreak;\n\t\tcase \"player_delta_ranking\":\n\t\t\tvar range = params[0];\n\t\t\tif (range !== \"1w\" && range !== \"4w\") {\n\t\t\t\treturn {\n\t\t\t\t\tcode: 400,\n\t\t\t\t\tbody: toJSON({\n\t\t\t\t\t\terror: \"invalid_param\"\n\t\t\t\t\t})\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tpath: \"/../../../\" + basename + \"_aggregates/_design/renderers/_show/generic_data/player_delta_ranking_\" + range\n\t\t\t};\n\t\t\tbreak;\n\t\tcase \"search_player\":\n\t\t\tvar prefix = params[0];\n\t\t\tif (!prefix) {\n\t\t\t\treturn {\n\t\t\t\t\tcode: 400,\n\t\t\t\t\tbody: toJSON({\n\t\t\t\t\t\terror: \"no_param\"\n\t\t\t\t\t})\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tpath: \"/../renderers/_list/search_player/nicknames/nicknames\",\n\t\t\t\tquery: {\n\t\t\t\t\t\"limit\": req2.query.limit || \"20\",\n\t\t\t\t\t\"startkey\": toJSON([prefix]),\n\t\t\t\t\t\"endkey\": toJSON([prefix + \"\\uffff\"]),\n\t\t\t\t\t\"group_level\": \"2\",\n\t\t\t\t\t\"stable\": \"false\",\n\t\t\t\t\t\"update\": \"lazy\"\n\t\t\t\t}\n\t\t\t};\n\t\t\tbreak;\n\t\tcase \"player_records\":\n\t\tcase \"player_stats\":\n\t\tcase \"player_extended_stats\":\n\t\t\tvar id = parseInt(params[0]);\n\t\t\tif (!id) {\n\t\t\t\treturn {\n\t\t\t\t\tcode: 400,\n\t\t\t\t\tbody: toJSON({\n\t\t\t\t\t\terror: \"invalid_id\"\n\t\t\t\t\t})\n\t\t\t\t};\n\t\t\t}\n\t\t\tvar startDate = parseTs(params[1] || \"0\");\n\t\t\tvar endDate = params[2] ? parseTs(params[2]) : null;\n\t\t\tvar key = [id];\n\t\t\tvar view = \"player_stats_2\";\n\t\t\tif (req2.query.mode) {\n\t\t\t\tvar modeId = parseInt(req2.query.mode);\n\t\t\t\tif (!modeId) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tcode: 400,\n\t\t\t\t\t\tbody: toJSON({\n\t\t\t\t\t\t\terror: \"invalid_mode_id\"\n\t\t\t\t\t\t})\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tkey.push(modeId);\n\t\t\t} else {\n\t\t\t\tkey.push(0);\n\t\t\t}\n\t\t\tif (method === \"player_records\") {\n\t\t\t\treturn {\n\t\t\t\t\tpath: \"/../renderers/_list/result_from_doc/\" + view + \"/player_stats\",\n\t\t\t\t\tquery: {\n\t\t\t\t\t\t\"limit\": req2.query.limit || \"100\",\n\t\t\t\t\t\t\"skip\": req2.query.skip || \"0\",\n\t\t\t\t\t\t\"reduce\": \"false\",\n\t\t\t\t\t\t\"include_docs\": \"true\",\n\t\t\t\t\t\t\"startkey\": toJSON(key.concat([dateToSecKey(startDate)])),\n\t\t\t\t\t\t\"endkey\": toJSON(key.concat([endDate ? dateToSecKey(endDate) : {}])),\n\t\t\t\t\t\t\"stable\": \"false\",\n\t\t\t\t\t\t\"update\": \"lazy\"\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t\tif (method === \"player_extended_stats\") {\n\t\t\t\treturn {\n\t\t\t\t\tpath: \"/../renderers/_list/player_extended_stats/player_extended_stats/player_stats\",\n\t\t\t\t\tquery: ({\n\t\t\t\t\t\t\"group_level\": key.length.toString(),\n\t\t\t\t\t\t\"startkey\": toJSON(key.concat([dateToSecKey(startDate)])),\n\t\t\t\t\t\t\"endkey\": toJSON(key.concat([endDate ? dateToSecKey(endDate) : {}])),\n\t\t\t\t\t\t\"stable\": \"false\",\n\t\t\t\t\t\t\"update\": \"lazy\"\n\t\t\t\t\t})\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tpath: \"/../renderers/_list/player_stats/\" + view + \"/player_stats\",\n\t\t\t\tquery: ({\n\t\t\t\t\t\"group_level\": key.length.toString(),\n\t\t\t\t\t\"startkey\": toJSON(key.concat([dateToSecKey(startDate)])),\n\t\t\t\t\t\"endkey\": toJSON(key.concat([endDate ? dateToSecKey(endDate) : {}])),\n\t\t\t\t\t\"stable\": \"false\",\n\t\t\t\t\t\"update\": \"lazy\"\n\t\t\t\t})\n\t\t\t};\n\t\t\tbreak;\n\t\tcase \"games\":\n\t\tcase \"count\":\n\t\t\tvar startTs = parseTs(params[0]);\n\t\t\tif (!startTs) {\n\t\t\t\treturn {\n\t\t\t\t\tcode: 400,\n\t\t\t\t\tbody: toJSON({\n\t\t\t\t\t\terror: \"invalid_start_time\"\n\t\t\t\t\t})\n\t\t\t\t};\n\t\t\t}\n\t\t\tvar endTs = params[1] ? parseTs(params[1]) : new Date(startTs.getTime() + MS_PER_DAY);\n\t\t\tif (!endTs) {\n\t\t\t\treturn {\n\t\t\t\t\tcode: 400,\n\t\t\t\t\tbody: toJSON({\n\t\t\t\t\t\terror: \"invalid_end_time\"\n\t\t\t\t\t})\n\t\t\t\t};\n\t\t\t}\n\t\t\tvar cacheMaxAge = (endTs.getTime() < (new Date()).getTime() - MS_PER_DAY / 2) ? 86400 : 60;\n\t\t\tif (method === \"count\") {\n\t\t\t\treturn {\n\t\t\t\t\tpath: \"/../renderers/_list/single_value/default/by_time\",\n\t\t\t\t\tquery: {\n\t\t\t\t\t\t\"startkey\": toJSON(dateToKey(startTs)),\n\t\t\t\t\t\t\"endkey\": toJSON(dateToKey(endTs)),\n\t\t\t\t\t\t\"maxage\": cacheMaxAge.toString(),\n\t\t\t\t\t\t\"stable\": \"false\",\n\t\t\t\t\t\t\"update\": \"lazy\"\n\t\t\t\t\t\t\"default\": '{\"count\":0}'\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tpath: \"/../renderers/_list/result/default/by_time\",\n\t\t\t\tquery: {\n\t\t\t\t\t\"limit\": req2.query.limit || \"100\",\n\t\t\t\t\t\"skip\": req2.query.skip || \"0\",\n\t\t\t\t\t\"startkey\": toJSON(dateToKey(startTs)),\n\t\t\t\t\t\"endkey\": toJSON(dateToKey(endTs)),\n\t\t\t\t\t\"maxage\": (cacheMaxAge * 15).toString(),\n\t\t\t\t\t\"reduce\": \"false\",\n\t\t\t\t\t\"stable\": \"false\",\n\t\t\t\t\t\"update\": \"lazy\"\n\t\t\t\t}\n\t\t\t};\n\t\t\tbreak;\n\t}\n\treturn {\n\t\tcode: 404,\n\t\tbody: toJSON({\n\t\t\terror: \"unknown_method\"\n\t\t})\n\t};\n}"
}